#!/bin/bash

get_battery() {
  capacity=$(cat /sys/class/power_supply/BAT1/capacity)
  status=$(cat /sys/class/power_supply/BAT1/status)

  icon="BAT"
  [ "$status" = "Charging" ] && icon="CHR"

  echo "[$icon $capacity%]"
}

get_ram() {
  mem=$(free -m | awk '/Mem:/ { printf("%.1fG/%.0fG", $3/1024, $2/1024) }')
  echo "[RAM $mem]"
}

get_storage() {
  hdd=$(df -h / | awk 'NR==2 { print $4 }')
  echo "[HDD $hdd]"
}

get_volume() {
  mute=$(pactl get-sink-mute @DEFAULT_SINK@ | awk '{print $2}')

  if [ "$mute" = "yes" ]; then
    echo "[VOL MUTE]"
  else
    vol=$(pactl get-sink-volume @DEFAULT_SINK@ | awk -F'/' '{ print $2 }' | head -1 | tr -d ' %')
    echo "[VOL $vol%]"
  fi
}

get_time() {
  # %I = Hour (01-12)
  # %M = Minute
  # %p = AM or PM
  echo "$(date '+%a %b %d %I:%M %p')"
}

#listen_volume() {
#  pactl subscribe | grep --line-buffered "sink" | while read -r event; do
#    current_vol=$(wpctl get-volume @DEFAULT_AUDIO_SINK@)
#    echo "Update UI with: $current_vol"
#  done
#}

#get_reminder() {
#  $file = "/tmp/reminder/$(date +"%H:%M")"
#  if [[ -f $file ]]; then
#    cat $file
#  fi
#}

get_ip() {
  echo "[IP: $(ip -4 addr show | awk '/inet 192\.168\./ {split($2,a,"/"); split(a[1],b,"."); print b[3]"."b[4]}')]"
}

get_cpu() {
  read -r cpu a b c d rest < /proc/stat
  prev_idle=$d
  prev_total=$((a+b+c+d))

  sleep 0.5

  read -r cpu a b c d rest < /proc/stat
  idle=$d
  total=$((a+b+c+d))

  usage=$((100 * ((total - prev_total) - (idle - prev_idle)) / (total - prev_total)))

  temp=$(cat /sys/class/thermal/thermal_zone0/temp)
  temp=$((temp / 1000))

  echo "[CPU: $usage% / ${temp}Â°C]"
}

get_next_prayer() {
	echo "[$(nextprayer)]";
} 

PREV_IDLE=0
PREV_TOTAL=0

# Main Loop
while true; do
	xsetroot -name "$(get_ip) $(get_cpu) $(get_storage) $(get_ram) $(get_battery) $(get_volume) $(get_next_prayer)  $(get_time)"
  sleep 2
done
